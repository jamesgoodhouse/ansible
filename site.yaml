---
- hosts: rpi
  roles:
  - role: common
    vars:
      sshd_client_alive_internal: 1800
    tags:
    - common
  - role: rpi
    tags:
    - rpi

- hosts: k3s_nodes
  environment:
    K8S_AUTH_KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  roles:
  - role: xanmanning.k3s
    vars:
      k3s_become_for_all: true
      k3s_build_cluster: false
      k3s_release_version: stable
      k3s_server:
        default-local-storage-path: /opt/k8s
      k3s_start_on_boot: true
      k3s_state: installed
    tags:
    - k3s

  - role: k8s_manifests/namespaces
    vars:
      namespaces:
      - name: cert-manager
        state: present
      - name: mosquitto
        state: present
      - name: openhab
        state: present
      - name: prometheus
        state: absent
      - name: ubiquiti
        state: present
    tags:
    - namespaces
    - k8s

  - role: k8s_manifests/cert-manager
    vars:
      cert_manager_helm_chart_version: v1.6.1
      cert_manager_state: present
      cert_manager_webhook_namecheap_api_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        63343030346133343337343063346630656238323563343465656631326339346335366239353733
        6165666264343661613966353631303635323565386535640a376465336239646333326430623461
        37393036633363353530376437383232333039316134666634316661636266623934303731323364
        6664613139633636380a643438666365356262613435386137636338666234643936303761336231
        33323265366339373635663362353966616163336539393136363065396536333364653661323436
        3433366564643938363362306433653337656632623933353561
      cert_manager_webhook_namecheap_api_user: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        37353038303534613832323666353939393532656334373930333365393266346333623134323733
        3236393362363333386534383362633732343864316435370a646130373464613931353632653366
        35633561333131613566356333303532396331303432656238646130613966396166626234653062
        6165323835353061370a626633356532626334303135306363656131633632633339336664336433
        3762
      cert_manager_webhook_namecheap_helm_chart_version: 0.1.0
    tags:
    - cert-manager
    - k8s

  - role: k8s_manifests/traefik
    vars:
      traefik_certificate_issuer: letsencrypt
      traefik_dashboard_host: traefik.k8s.home.goodhouse.io
      traefik_state: present
      traefik_users: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        31613238333466653137613330613565346336373032306133646566316562373735303764326338
        3136373738656665363031633366393135383538653532620a323134643431376438323531326462
        65633437643461396435363632666538343564666563386531663839373730643238646333353265
        3339393864316339640a663566623031626238356536333431346266663031633562383461633835
        37366461353138303361376530366439343938383465653439316237666239636139633338626161
        3435636530613135323562383534376235393538383037356261
    tags:
    - traefik
    - k8s

  - role: k8s_manifests/mosquitto
    vars:
      mosquitto_host: mqtt.home.goodhouse.io
      mosquitto_image_version: 2.0.13
      mosquitto_passwd: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        33323436326665636266326561376262636336623663613137636338666465346137353363643866
        3735393462653837613138306235653430353034346661380a383165616630646133306236323233
        62336630313434336261663935376336316633656633633135643234383166623430613435623766
        3935306334336230640a626438346535393533373763313935346666633861383033653631616135
        32393163336664663137356235366165623030646531653735306439306437663761333163646162
        63393038633263396235313035376131373762343562343730336537613763613965366165383462
        61653663646362636139343561316639343936353531643138363566663965386563666532653531
        33393163393166373463623862653738306438353634646364333562623935323563323531383833
        63636361646333306137373261366233623336633435346563663136613763383835313031373237
        37303933636632343865663934323365323334343530336566333361613237646131326435306462
        39323934613063343231646462626265326462353732323162626565356239363362383066633238
        62356464613061663664646364303463636138653231376434303530323132633239363461643062
        65366239333836636437643564376235323633333039376365626234666132613635653939386637
        33393764386166643834396532346434386130646530663938616130613465376638396437306464
        35656264393030323439613032333065393732623737323339306637386463386265316531383563
        31356238363437323236636632316365316338626664663337626361633533373965363738326239
        38376530666565373839313332306233323431623338383837323063613838343438653362386462
        66386530636338653261366538346230333536623333613433346339333933613737313930313864
        34323935373736396238666462663430343633313731663364303231653837626165666233303138
        32613363326662386131623634356563393964646162646566346233363836636239646335393139
        34643632343262643435366364323961383862646636326132616564326665386531363732326431
        35633637353937343434623764613166616331643130396162356539343663643531616264363362
        38333663316538303837623737373033656135336334656335333736393436613432323665366661
        61346361343933393534383464323234313334333731353039633931393439326664636439333737
        31663462376633303033303161333135313965323363633733353037313939343062646630643731
        37633336343535363064613761326466633039356236626634633262303164646635363331393765
        36393038306239666563343937663766316663613862663733323730373831643139613566323435
        35396630343835306565663834663536663633353831303639393037313536616562383139323732
        65626562343033313931306136353132313938356439346131653436666361663233393662623863
        66346134633832646665373632626462366461326532623662396638366138363336376233663231
        35356430663430373161393637323630623265383139366233336361653262643962376638623636
        36643063613966336163396638623565653036626565663537343163623665353961626436373362
        39616434313832663166656336376539656538366439623361623839653930303238346339636136
        3632326135646565306333633438303464663932616532306463
      mosquitto_state: present
    tags:
    - mosquitto
    - k8s

  - role: k8s_manifests/openhab
    vars:
      openhab_certificate_issuer: letsencrypt
      openhab_config_builder_version: v1.2.2
      openhab_config_builder_age_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        65386362626362646138363565633937333661363661643038373863376635383235623937306131
        6135613664663738343137636235313939613664636430340a333134646665633533623438653339
        63326163393463663038323038306535393165343733653130303533643635326431643835316565
        3562373661343037370a376332356236666639326161333539656166653365383735373430383635
        32643438626666666536353335663034643564643065343937316164383931333836363439666461
        37333937336563396461636339663766383131346336363665616435363366616366613136386330
        62366237303161326366386437303439626336636232383463616430303431643565613631633563
        34346537303366356162
      openhab_helm_chart_version: 0.1.5
      openhab_state: present
    tags:
    - openhab
    - k8s

  - role: k8s_manifests/ubiquiti
    vars:
      ubiquiti_gui_host: unifi.home.goodhouse.io
      ubiquiti_state: present
      ubiquiti_unifi_certificate_issuer: letsencrypt
    tags:
    - ubiquiti
    - unifi
    - k8s

  - role: k8s_manifests/fireplacectl
    vars:
      fireplacectl_namespace: openhab
      fireplacectl_state: present
    tags:
    - fireplacectl
    - k8s

  - role: k8s_manifests/sensor-reporter
    vars:
      sensor_reporter_config: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        37656366376531326461303762346335613439373131303439343533633433346639663235643539
        3536623961333434303539373134666130323830366631340a393533396264326664383032396132
        30636335306266356266306165613632626631346266393866616236336562656336336431326335
        6636656639653930330a366632333435663037373536316636313764363961363932633231343663
        36656361333962373561666233323534326166353336386436626564626635663439303733356334
        64363536343266373931396365643862376233613434333832643234373639663734633738633564
        34666165643131646232316434306533666630633462656130373366376332353439393865336638
        35633635633431333434323564323765326438623430613362343836643061336337366139653932
        37636666366361646436316136336638653832656439653566343364343661646530363434623436
        35366366336263666434653130636536313432306539333134313564366663326562636361633331
        35373033643463393665636465316530353463323135343133633531333039353539323061303537
        65386163646134656536336136396333366465353865656636636131303566323563353735383331
        63343734663861323666613366303165353835393062663933373330616261333561386633313332
        34303964613166313237313461663830393136356539323138316563643265663034656664616339
        61663339323132663539343333633230613063333531313538663266373233313438393564666130
        30623931363130643166333437353165616331316638356562363863376162346232636331396666
        65643339626665643365363933396438353237343135326439326236613564386463653935393539
        63343961386537316662393364306463346463623462366335333362343639656430623133363863
        32383763376561363361383435653565313538633064333364633064313935316432633231393138
        65393836373933643466653662643365366435363936656464636534323262626536333763313264
        34323932396138303163383337656566376161333461383863353631633031393738386237303764
        63616564636135623933363732303536646334663933313561366231316564383632306363613434
        33383938343135653137663332626664383064663232363839383337386133343539613062306630
        38363732646461663734366262626665663932363932373631333964613531646664646130616363
        35643666376430336535636431313738383237666462373463326664313638333830636430323335
        65303336616131633863336133313261353530303861373839386530666631383937323635336533
        34653931613562323330663162306333373235393064333934386635383336386337616465376433
        32653765363866336235623665386530383164666161343338633163326565383035653264633438
        32616336633939646231313861646433356437663735376637343333383365386430393430613933
        61633362656266373931636533623738653230346166333366353536343962316434383539386335
        36626433633664313436626238373334613930316331633232323461393336383533343032386130
        31396238656338626433613266323565646435656338653534313165666531626435346232383931
        38626435323538613138376134383165346330353164623261363964613262666331636366623037
        31396664336432383730626630613132333135383665303863383134383565336461353361356332
        62363734633437613035353065663361666230626336636664356134373932316530643737303733
        34663033396564363835306435656535306234653039306639343231303939343766646563666564
        39396632633839373861613864373030356639316334343338326539396364303336306461666536
        3464613062336666366530326539366362643733663361613762
      sensor_reporter_namespace: openhab
      sensor_reporter_state: present
    tags:
    - sensor-reporter
    - k8s

  - role: k8s_manifests/prometheus
    vars:
      prometheus_helm_chart_version: 18.0.6
      prometheus_grafana_admin_password: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        31663032333564666364616162323833646638333735386161386635316336353436323135656166
        6261636431303562373834396339336561383734616230620a663730323265396238396436646265
        61623461336565633332626536623363316461633037313733626633343161346639613162346331
        3363636362613732340a666534393561306635356131303166333134623964663662633261646262
        65336335363233366232306535303932306661636362323330623365303863353937643037363431
        6366633137333039643532336636613837343230313530653431
      prometheus_grafana_admin_user: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        36363432316632386334363736613962376439303062623735386136636461633465383961613632
        3837656630616133626231363362343438336631636536360a623062643531633166313430306638
        38313363336430323734353765346162306165373134386534646161643264306661623435366363
        6535383637396539310a346633616639646339363963623039376639353230616635393364303265
        3938
      prometheus_state: absent
    tags:
    - prometheus
    - k8s
