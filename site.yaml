---
- hosts: rpi
  roles:
  - role: common
  - role: rpi

- hosts: k3s_nodes
  environment:
    K8S_AUTH_KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  roles:
  - role: xanmanning.k3s
    vars:
      k3s_become_for_all: true
      k3s_build_cluster: false
      k3s_release_version: stable
      k3s_start_on_boot: true
      k3s_state: installed
      k3s_server:
        default-local-storage-path: /opt/k8s
    tags:
    - k3s
  - role: deployments/cert-manager
    vars:
      namecheap_api_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        63343030346133343337343063346630656238323563343465656631326339346335366239353733
        6165666264343661613966353631303635323565386535640a376465336239646333326430623461
        37393036633363353530376437383232333039316134666634316661636266623934303731323364
        6664613139633636380a643438666365356262613435386137636338666234643936303761336231
        33323265366339373635663362353966616163336539393136363065396536333364653661323436
        3433366564643938363362306433653337656632623933353561
      namecheap_api_user: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        37353038303534613832323666353939393532656334373930333365393266346333623134323733
        3236393362363333386534383362633732343864316435370a646130373464613931353632653366
        35633561333131613566356333303532396331303432656238646130613966396166626234653062
        6165323835353061370a626633356532626334303135306363656131633632633339336664336433
        3762
    tags:
    - cert-manager
    - k8s
  - role: deployments/traefik
    vars:
      dashboard_host: traefik.k8s.home.goodhouse.io
      users: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        65616631626365353336633734663234636636346433313138376230633532313534623939633534
        3839653238633032303738626330383539343131343264320a616431616331646265623163633065
        34376262396466613263323861326536326333333431323031363835333765663439363034336336
        6364633431316162610a313664626564323732663038633132323632396139303631623535353736
        62643031353132346161653232306337383336306663376630343161326235613539336630656231
        3135353566323433393139363663353739386434316233616239
    tags:
    - traefik
    - k8s
  - role: deployments/openhab
    tags:
    - openhab
    - k8s
  - role: deployments/ubiquiti
    vars:
      gui_host: unifi.home.goodhouse.io
    tags:
    - ubiquiti
    - unifi
    - k8s
