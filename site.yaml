---
- hosts: rpi
  roles:
  - role: common
    vars:
      sshd_client_alive_internal: 1800
    tags:
    - common
  - role: rpi
    tags:
    - rpi

- hosts: k3s_nodes
  environment:
    K8S_AUTH_KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  roles:
  - role: xanmanning.k3s
    vars:
      k3s_become_for_all: true
      k3s_build_cluster: false
      k3s_release_version: stable
      k3s_server:
        default-local-storage-path: /opt/k8s
      k3s_start_on_boot: true
      k3s_state: installed
    tags:
    - k3s

  - role: k8s_manifests/namespaces
    vars:
      namespaces:
      - name: cert-manager
        state: present
      - name: mosquitto
        state: present
      - name: openhab
        state: present
      - name: prometheus
        state: absent
      - name: ubiquiti
        state: present
    tags:
    - namespaces
    - k8s

  - role: k8s_manifests/cert-manager
    vars:
      cert_manager_helm_chart_version: v1.6.1
      cert_manager_state: present
      cert_manager_webhook_namecheap_api_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        63343030346133343337343063346630656238323563343465656631326339346335366239353733
        6165666264343661613966353631303635323565386535640a376465336239646333326430623461
        37393036633363353530376437383232333039316134666634316661636266623934303731323364
        6664613139633636380a643438666365356262613435386137636338666234643936303761336231
        33323265366339373635663362353966616163336539393136363065396536333364653661323436
        3433366564643938363362306433653337656632623933353561
      cert_manager_webhook_namecheap_api_user: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        37353038303534613832323666353939393532656334373930333365393266346333623134323733
        3236393362363333386534383362633732343864316435370a646130373464613931353632653366
        35633561333131613566356333303532396331303432656238646130613966396166626234653062
        6165323835353061370a626633356532626334303135306363656131633632633339336664336433
        3762
      cert_manager_webhook_namecheap_helm_chart_version: 0.1.0
    tags:
    - cert-manager
    - k8s

  - role: k8s_manifests/traefik
    vars:
      traefik_certificate_issuer: letsencrypt
      traefik_dashboard_host: traefik.k8s.home.goodhouse.io
      traefik_state: present
      traefik_users: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        31613238333466653137613330613565346336373032306133646566316562373735303764326338
        3136373738656665363031633366393135383538653532620a323134643431376438323531326462
        65633437643461396435363632666538343564666563386531663839373730643238646333353265
        3339393864316339640a663566623031626238356536333431346266663031633562383461633835
        37366461353138303361376530366439343938383465653439316237666239636139633338626161
        3435636530613135323562383534376235393538383037356261
    tags:
    - traefik
    - k8s

  - role: k8s_manifests/mosquitto
    vars:
      mosquitto_host: mqtt.home.goodhouse.io
      mosquitto_image_version: 2.0.13
      mosquitto_passwd: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        33323436326665636266326561376262636336623663613137636338666465346137353363643866
        3735393462653837613138306235653430353034346661380a383165616630646133306236323233
        62336630313434336261663935376336316633656633633135643234383166623430613435623766
        3935306334336230640a626438346535393533373763313935346666633861383033653631616135
        32393163336664663137356235366165623030646531653735306439306437663761333163646162
        63393038633263396235313035376131373762343562343730336537613763613965366165383462
        61653663646362636139343561316639343936353531643138363566663965386563666532653531
        33393163393166373463623862653738306438353634646364333562623935323563323531383833
        63636361646333306137373261366233623336633435346563663136613763383835313031373237
        37303933636632343865663934323365323334343530336566333361613237646131326435306462
        39323934613063343231646462626265326462353732323162626565356239363362383066633238
        62356464613061663664646364303463636138653231376434303530323132633239363461643062
        65366239333836636437643564376235323633333039376365626234666132613635653939386637
        33393764386166643834396532346434386130646530663938616130613465376638396437306464
        35656264393030323439613032333065393732623737323339306637386463386265316531383563
        31356238363437323236636632316365316338626664663337626361633533373965363738326239
        38376530666565373839313332306233323431623338383837323063613838343438653362386462
        66386530636338653261366538346230333536623333613433346339333933613737313930313864
        34323935373736396238666462663430343633313731663364303231653837626165666233303138
        32613363326662386131623634356563393964646162646566346233363836636239646335393139
        34643632343262643435366364323961383862646636326132616564326665386531363732326431
        35633637353937343434623764613166616331643130396162356539343663643531616264363362
        38333663316538303837623737373033656135336334656335333736393436613432323665366661
        61346361343933393534383464323234313334333731353039633931393439326664636439333737
        31663462376633303033303161333135313965323363633733353037313939343062646630643731
        37633336343535363064613761326466633039356236626634633262303164646635363331393765
        36393038306239666563343937663766316663613862663733323730373831643139613566323435
        35396630343835306565663834663536663633353831303639393037313536616562383139323732
        65626562343033313931306136353132313938356439346131653436666361663233393662623863
        66346134633832646665373632626462366461326532623662396638366138363336376233663231
        35356430663430373161393637323630623265383139366233336361653262643962376638623636
        36643063613966336163396638623565653036626565663537343163623665353961626436373362
        39616434313832663166656336376539656538366439623361623839653930303238346339636136
        3632326135646565306333633438303464663932616532306463
      mosquitto_state: present
    tags:
    - mosquitto
    - k8s

  - role: k8s_manifests/openhab
    vars:
      openhab_certificate_issuer: letsencrypt
      openhab_config_builder_version: v1.2.2
      openhab_config_builder_age_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        65386362626362646138363565633937333661363661643038373863376635383235623937306131
        6135613664663738343137636235313939613664636430340a333134646665633533623438653339
        63326163393463663038323038306535393165343733653130303533643635326431643835316565
        3562373661343037370a376332356236666639326161333539656166653365383735373430383635
        32643438626666666536353335663034643564643065343937316164383931333836363439666461
        37333937336563396461636339663766383131346336363665616435363366616366613136386330
        62366237303161326366386437303439626336636232383463616430303431643565613631633563
        34346537303366356162
      openhab_helm_chart_version: 0.1.5
      openhab_state: present
    tags:
    - openhab
    - k8s

  - role: k8s_manifests/ubiquiti
    vars:
      ubiquiti_gui_host: unifi.home.goodhouse.io
      ubiquiti_state: present
      ubiquiti_unifi_certificate_issuer: letsencrypt
    tags:
    - ubiquiti
    - unifi
    - k8s

  - role: k8s_manifests/fireplacectl
    vars:
      fireplacectl_namespace: openhab
      fireplacectl_state: present
    tags:
    - fireplacectl
    - k8s

  - role: k8s_manifests/sensor-reporter
    vars:
      sensor_reporter_config: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        35313539333237656431363065346639666533646166303630383131646330613730623637326338
        6262633537656634313765353036613731336439616636650a363163336266346134363039613633
        61656264356531323435353331356330346664363739366238376132363337333961353131633065
        6138376664353637610a396238633034373735653337356162343433646438343130393135623938
        32346365313732326165633565623437323330376632303332626137393736613938323439663934
        65633965346339326561653664353938326331333461613230376461653464623130656234333637
        37333532656531653131326430336566373466323737653337643366326266333364386433303263
        66623062633830363035616539336463303134663539623235396636333534326538373438613231
        65353863633762343065353134333236666130353831623964386634336164376538336437323964
        38343237613335643930383338366539616563623363646266333433633166316364343137626363
        65323139386239393530653733313333373539396532306464623734323163373331336537313163
        36383034626339316431306636303665343862376331326334643835613538623039646437376535
        34336634623063626434633136353963313332303838643265613865633966346364386633666263
        34643239643538353037636237383936393962623365336233326462353330643365303961383733
        64643934323633653731303436333164313161613836363136646262363630616234653263363464
        63373632373838626137653532623662663733373637386665346665663030313734656331393463
        62646562643063613738383730383634373639643836623633366263356238626335333238316432
        64306635616134383838383464646163376138333132643864323431643934623132346362636236
        39633335623362313339616139343431323665306464373032306264363335313737333539623463
        34646635306338383535323361373538313632396564636339663130313365633232626332653165
        38373336333966396431613564323466373434643862323630383565306235633165313463653331
        64373734323431623461306535373833663136346539313564363332333135653864626439653736
        31623232346636663333626334626462313230303531393762623033383962633736313061343030
        63346361303161623337303063663538393638393232383535373639386235636264386666393238
        36336630353266643838363332643361373631646335343864376336656230323139633938326330
        32626663363936326232393962386138353931346130666665616438346533333934373139613365
        36316636373138313234633439616432313339643863653535663237333437326435373036326539
        35633533666237613830343032393730303237343738643066626336663637646664393163613163
        30303966303335646430373561396237323666396433356439623639303732656438356435356663
        39313735353562376631616261383033656335363539336161386665393664623035653662303639
        62613036653237373431626537616462326634363639333237323933316337666134346464366139
        33373562306464666632643665373936313438333262633464663033663962646433393338346363
        30623334666434623138313664353131343336366133313137396165393435613131306664313566
        34656635343833356339306633336438353765373965626161616230316435666230316130353036
        36626164303039363635663035356231656361353731666338346637633237623435306535323730
        66623932623738353962613365393838626436303337313232386639306630623831626239386334
        65393332633431386363373963633466363632366133386336643334623138316232343239663035
        3930386331666432373035306632373233333838666461313066
      sensor_reporter_namespace: openhab
      sensor_reporter_state: present
    tags:
    - sensor-reporter
    - k8s

  - role: k8s_manifests/prometheus
    vars:
      prometheus_helm_chart_version: 18.0.6
      prometheus_grafana_admin_password: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        31663032333564666364616162323833646638333735386161386635316336353436323135656166
        6261636431303562373834396339336561383734616230620a663730323265396238396436646265
        61623461336565633332626536623363316461633037313733626633343161346639613162346331
        3363636362613732340a666534393561306635356131303166333134623964663662633261646262
        65336335363233366232306535303932306661636362323330623365303863353937643037363431
        6366633137333039643532336636613837343230313530653431
      prometheus_grafana_admin_user: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        36363432316632386334363736613962376439303062623735386136636461633465383961613632
        3837656630616133626231363362343438336631636536360a623062643531633166313430306638
        38313363336430323734353765346162306165373134386534646161643264306661623435366363
        6535383637396539310a346633616639646339363963623039376639353230616635393364303265
        3938
      prometheus_state: absent
    tags:
    - prometheus
    - k8s
