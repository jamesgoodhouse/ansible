---
- hosts: rpi
  roles:
  - role: common
  - role: rpi

- hosts: k3s_nodes
  environment:
    K8S_AUTH_KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  roles:
  - role: xanmanning.k3s
    vars:
      k3s_become_for_all: true
      k3s_build_cluster: false
      k3s_release_version: stable
      k3s_start_on_boot: true
      k3s_state: installed
      k3s_server:
        default-local-storage-path: /opt/k8s
    tags:
    - k3s
  - role: k8s_manifests/cert-manager
    vars:
      namecheap_api_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        63343030346133343337343063346630656238323563343465656631326339346335366239353733
        6165666264343661613966353631303635323565386535640a376465336239646333326430623461
        37393036633363353530376437383232333039316134666634316661636266623934303731323364
        6664613139633636380a643438666365356262613435386137636338666234643936303761336231
        33323265366339373635663362353966616163336539393136363065396536333364653661323436
        3433366564643938363362306433653337656632623933353561
      namecheap_api_user: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        37353038303534613832323666353939393532656334373930333365393266346333623134323733
        3236393362363333386534383362633732343864316435370a646130373464613931353632653366
        35633561333131613566356333303532396331303432656238646130613966396166626234653062
        6165323835353061370a626633356532626334303135306363656131633632633339336664336433
        3762
    tags:
    - cert-manager
    - k8s
  - role: k8s_manifests/traefik
    vars:
      dashboard_host: traefik.k8s.home.goodhouse.io
      users: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        31613238333466653137613330613565346336373032306133646566316562373735303764326338
        3136373738656665363031633366393135383538653532620a323134643431376438323531326462
        65633437643461396435363632666538343564666563386531663839373730643238646333353265
        3339393864316339640a663566623031626238356536333431346266663031633562383461633835
        37366461353138303361376530366439343938383465653439316237666239636139633338626161
        3435636530613135323562383534376235393538383037356261
    tags:
    - traefik
    - k8s

  - role: k8s_manifests/mosquitto
    vars:
      passwd: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        33323436326665636266326561376262636336623663613137636338666465346137353363643866
        3735393462653837613138306235653430353034346661380a383165616630646133306236323233
        62336630313434336261663935376336316633656633633135643234383166623430613435623766
        3935306334336230640a626438346535393533373763313935346666633861383033653631616135
        32393163336664663137356235366165623030646531653735306439306437663761333163646162
        63393038633263396235313035376131373762343562343730336537613763613965366165383462
        61653663646362636139343561316639343936353531643138363566663965386563666532653531
        33393163393166373463623862653738306438353634646364333562623935323563323531383833
        63636361646333306137373261366233623336633435346563663136613763383835313031373237
        37303933636632343865663934323365323334343530336566333361613237646131326435306462
        39323934613063343231646462626265326462353732323162626565356239363362383066633238
        62356464613061663664646364303463636138653231376434303530323132633239363461643062
        65366239333836636437643564376235323633333039376365626234666132613635653939386637
        33393764386166643834396532346434386130646530663938616130613465376638396437306464
        35656264393030323439613032333065393732623737323339306637386463386265316531383563
        31356238363437323236636632316365316338626664663337626361633533373965363738326239
        38376530666565373839313332306233323431623338383837323063613838343438653362386462
        66386530636338653261366538346230333536623333613433346339333933613737313930313864
        34323935373736396238666462663430343633313731663364303231653837626165666233303138
        32613363326662386131623634356563393964646162646566346233363836636239646335393139
        34643632343262643435366364323961383862646636326132616564326665386531363732326431
        35633637353937343434623764613166616331643130396162356539343663643531616264363362
        38333663316538303837623737373033656135336334656335333736393436613432323665366661
        61346361343933393534383464323234313334333731353039633931393439326664636439333737
        31663462376633303033303161333135313965323363633733353037313939343062646630643731
        37633336343535363064613761326466633039356236626634633262303164646635363331393765
        36393038306239666563343937663766316663613862663733323730373831643139613566323435
        35396630343835306565663834663536663633353831303639393037313536616562383139323732
        65626562343033313931306136353132313938356439346131653436666361663233393662623863
        66346134633832646665373632626462366461326532623662396638366138363336376233663231
        35356430663430373161393637323630623265383139366233336361653262643962376638623636
        36643063613966336163396638623565653036626565663537343163623665353961626436373362
        39616434313832663166656336376539656538366439623361623839653930303238346339636136
        3632326135646565306333633438303464663932616532306463
    tags:
    - mosquitto
    - k8s
  - role: k8s_manifests/openhab
    tags:
    - openhab
    - k8s
  - role: k8s_manifests/ubiquiti
    vars:
      gui_host: unifi.home.goodhouse.io
    tags:
    - ubiquiti
    - unifi
    - k8s
