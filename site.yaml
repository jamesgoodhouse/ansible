---
- hosts: rpi
  roles:
  - role: common
    tags:
    - common
  - role: rpi
    tags:
    - rpi

- hosts: k3s_nodes
  environment:
    K8S_AUTH_KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  roles:
  - role: xanmanning.k3s
    vars:
      k3s_become_for_all: true
      k3s_build_cluster: false
      k3s_release_version: stable
      k3s_start_on_boot: true
      k3s_state: installed
      k3s_server:
        default-local-storage-path: /opt/k8s
    tags:
    - k3s
  - role: k8s_manifests/namespaces
    vars:
      namespaces:
      - name: cert-manager
        state: present
      - name: mosquitto
        state: present
      - name: openhab
        state: present
      - name: ubiquiti
        state: present
    tags:
    - namespaces
    - k8s
  - role: k8s_manifests/cert-manager
    vars:
      cert_manager_helm_chart_version: v1.5.3
      cert_manager_state: present
      cert_manager_webhook_namecheap_api_key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        63343030346133343337343063346630656238323563343465656631326339346335366239353733
        6165666264343661613966353631303635323565386535640a376465336239646333326430623461
        37393036633363353530376437383232333039316134666634316661636266623934303731323364
        6664613139633636380a643438666365356262613435386137636338666234643936303761336231
        33323265366339373635663362353966616163336539393136363065396536333364653661323436
        3433366564643938363362306433653337656632623933353561
      cert_manager_webhook_namecheap_api_user: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        37353038303534613832323666353939393532656334373930333365393266346333623134323733
        3236393362363333386534383362633732343864316435370a646130373464613931353632653366
        35633561333131613566356333303532396331303432656238646130613966396166626234653062
        6165323835353061370a626633356532626334303135306363656131633632633339336664336433
        3762
      cert_manager_webhook_namecheap_helm_chart_version: 0.1.0
    tags:
    - cert-manager
    - k8s
  - role: k8s_manifests/traefik
    vars:
      traefik_certificate_issuer: letsencrypt
      traefik_dashboard_host: traefik.k8s.home.goodhouse.io
      traefik_state: present
      traefik_users: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        31613238333466653137613330613565346336373032306133646566316562373735303764326338
        3136373738656665363031633366393135383538653532620a323134643431376438323531326462
        65633437643461396435363632666538343564666563386531663839373730643238646333353265
        3339393864316339640a663566623031626238356536333431346266663031633562383461633835
        37366461353138303361376530366439343938383465653439316237666239636139633338626161
        3435636530613135323562383534376235393538383037356261
    tags:
    - traefik
    - k8s

  - role: k8s_manifests/mosquitto
    vars:
      mosquitto_host: mqtt.home.goodhouse.io
      mosquitto_passwd: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        33323436326665636266326561376262636336623663613137636338666465346137353363643866
        3735393462653837613138306235653430353034346661380a383165616630646133306236323233
        62336630313434336261663935376336316633656633633135643234383166623430613435623766
        3935306334336230640a626438346535393533373763313935346666633861383033653631616135
        32393163336664663137356235366165623030646531653735306439306437663761333163646162
        63393038633263396235313035376131373762343562343730336537613763613965366165383462
        61653663646362636139343561316639343936353531643138363566663965386563666532653531
        33393163393166373463623862653738306438353634646364333562623935323563323531383833
        63636361646333306137373261366233623336633435346563663136613763383835313031373237
        37303933636632343865663934323365323334343530336566333361613237646131326435306462
        39323934613063343231646462626265326462353732323162626565356239363362383066633238
        62356464613061663664646364303463636138653231376434303530323132633239363461643062
        65366239333836636437643564376235323633333039376365626234666132613635653939386637
        33393764386166643834396532346434386130646530663938616130613465376638396437306464
        35656264393030323439613032333065393732623737323339306637386463386265316531383563
        31356238363437323236636632316365316338626664663337626361633533373965363738326239
        38376530666565373839313332306233323431623338383837323063613838343438653362386462
        66386530636338653261366538346230333536623333613433346339333933613737313930313864
        34323935373736396238666462663430343633313731663364303231653837626165666233303138
        32613363326662386131623634356563393964646162646566346233363836636239646335393139
        34643632343262643435366364323961383862646636326132616564326665386531363732326431
        35633637353937343434623764613166616331643130396162356539343663643531616264363362
        38333663316538303837623737373033656135336334656335333736393436613432323665366661
        61346361343933393534383464323234313334333731353039633931393439326664636439333737
        31663462376633303033303161333135313965323363633733353037313939343062646630643731
        37633336343535363064613761326466633039356236626634633262303164646635363331393765
        36393038306239666563343937663766316663613862663733323730373831643139613566323435
        35396630343835306565663834663536663633353831303639393037313536616562383139323732
        65626562343033313931306136353132313938356439346131653436666361663233393662623863
        66346134633832646665373632626462366461326532623662396638366138363336376233663231
        35356430663430373161393637323630623265383139366233336361653262643962376638623636
        36643063613966336163396638623565653036626565663537343163623665353961626436373362
        39616434313832663166656336376539656538366439623361623839653930303238346339636136
        3632326135646565306333633438303464663932616532306463
      mosquitto_state: present
    tags:
    - mosquitto
    - k8s
  - role: k8s_manifests/openhab
    vars:
      openhab_certificate_issuer: letsencrypt
      openhab_helm_chart_version: 0.1.4
      openhab_state: present
    tags:
    - openhab
    - k8s
  - role: k8s_manifests/ubiquiti
    vars:
      ubiquiti_gui_host: unifi.home.goodhouse.io
      ubiquiti_state: present
      ubiquiti_unifi_certificate_issuer: letsencrypt
    tags:
    - ubiquiti
    - unifi
    - k8s
  - role: k8s_manifests/fireplacectl
    vars:
      fireplacectl_namespace: openhab
      fireplacectl_state: present
    tags:
    - fireplacectl
    - k8s
  - role: k8s_manifests/sensor-reporter
    vars:
      sensor_reporter_config: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        64383437396432626630343839373234363233373731323838653864653439613139336136666662
        6336393831363235396533383833393036663963303936370a663962386632643735393238353433
        32363435343733653933633766663762393965623932346562633163626433383163346638313365
        3062373035613464300a326438386465376237626430613534663737626238336433353131373531
        61626535343362363937313563386538393863323635333064303165386265366537646234376538
        66323363393731336261623930613832393934643530656331323761666235663039373264633739
        63333134353564316136323736323734363633366162353136383638616535303232386436636230
        30616138323837666234313966316264356630333732323434316239653662363861383730666631
        34653264376637393964646563663531313435633963373066356538356563346464313335613834
        37626366316462353534333235303637616136343362626262636235383539363834353962633766
        37356233656436336130336462366165646638343331383135653530373433356130383636633135
        65396339353731303564376631633937323034343433613836303463613838626666333035643762
        39303661663563303733313962666335653136323262353336383936393165313238343739633636
        65653539333532333731663433313163626264323134663736323665616539616332383563333864
        61346463383031383664393434613966616235323066386435393864353437356331353663353538
        64316231313633343830646332383437356364623137646663663035636637346534316464313839
        64623662386633343039333432343332393931306363346639363530316662613731353761646539
        34336561643866336433346162383132373730366130343037656263306265373635356635343466
        65376663323733626139663239646634626164663933353838343133306631316234313731633165
        61333338323661623232656661303331393761643537643265353632643837636438386637623636
        63643732393838316537396632376536373130363264666138313265663033356362313562326433
        37646232323834623432303131316166663263653334653165306463653935616166356431393731
        38373335633336643439383231626465653231333634396463633736343035343231366238393439
        33323737346334343262653266303334313064383862303437356662373734376631326262306535
        35613039663466393432373835336532316239636338663836356362383137356337396461323834
        36313630373438356333376230613264313463396635663762633333373762663931613665386535
        65653130316635316566666635663936356566653932303331623132383263396134336135663631
        36653961376432616231626565386237383866653365353961323961626130336161386462636139
        65373130336634663938656337623332623535656239303436396530383530393461346436653466
        3738613233636138616438613339343262313431636263396330
      sensor_reporter_namespace: openhab
      sensor_reporter_state: present
    tags:
    - sensor-reporter
    - k8s
