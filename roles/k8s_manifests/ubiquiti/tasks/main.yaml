- name: Deploy Helm chart
  community.kubernetes.k8s:
    state: "{{ ubiquiti_state }}"
    namespace: "{{ ubiquiti_namespace }}"
    resource_definition:
      apiVersion: helm.cattle.io/v1
      kind: HelmChart
      metadata:
        name: unifi
      spec:
        chart: unifi
        repo: https://jamesgoodhouse.github.io/helm-charts
        version: 0.1.20
        valuesContent: |-
          ingressroute:
            enabled: true
            host: "{{ ubiquiti_gui_host }}"
            tls:
              passthrough: true
              secretName: "{{ ubiquiti_gui_host }}"
          rsync_backup:
            enabled: true

- name: Deploy Certificate
  community.kubernetes.k8s:
    state: "{{ ubiquiti_state }}"
    namespace: "{{ ubiquiti_namespace }}"
    resource_definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: "{{ ubiquiti_gui_host }}"
        namespace: ubiquiti
      spec:
        dnsNames:
        - "{{ ubiquiti_gui_host }}"
        secretName: "{{ ubiquiti_gui_host }}"
        issuerRef:
          name: letsencrypt
          kind: ClusterIssuer
